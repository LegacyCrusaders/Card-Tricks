<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Prediction</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    margin: 0;
    background: black;
    color: white;
    font-family: Arial, Helvetica, sans-serif;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100vh;
    text-align: center;
  }
  #text {
    font-size: 2.2em;
    padding: 20px;
  }
</style>
</head>
<body>

<div id="text">Tap to begin<br><br>Version 4</div>

<script>
let started = false;
let faceDown = false;
let revealed = false;
let lastDirection = null;

const text = document.getElementById("text");
const EARLY_Z_TRIGGER = -4; // triggers while phone is still angled

// Wake lock variable
let wakeLock = null;

// Request wake lock to keep screen on
async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
      wakeLock.addEventListener('release', () => {
        console.log('Wake lock released');
      });
      console.log('Wake lock active');
    }
  } catch (err) {
    console.log('Wake lock not available:', err);
  }
}

function requestMotionPermission() {
  if (
    typeof DeviceMotionEvent !== "undefined" &&
    typeof DeviceMotionEvent.requestPermission === "function"
  ) {
    DeviceMotionEvent.requestPermission().then(response => {
      if (response === "granted") {
        startMotion();
        requestWakeLock();
      } else {
        text.innerHTML = "Motion permission denied";
      }
    });
  } else {
    startMotion();
    requestWakeLock();
  }
}

function startMotion() {
  started = true;
  text.innerHTML = "Version 4<br><br>Set phone down";
  window.addEventListener("devicemotion", handleMotion);
}

function handleMotion(event) {
  if (!event.accelerationIncludingGravity) return;

  const x = event.accelerationIncludingGravity.x;
  const y = event.accelerationIncludingGravity.y;
  const z = event.accelerationIncludingGravity.z;

  // Detect face-down
  if (z < -7) {
    faceDown = true;
    revealed = false;
    text.innerHTML = "Version 4<br><br>(waiting)";
    return;
  }

  // Lock prediction very early
  if (faceDown && !revealed && z > EARLY_Z_TRIGGER) {
    revealed = true;
    faceDown = false;
    revealPrediction();
  }

  // Track dominant direction continuously
  if (Math.abs(x) > Math.abs(y)) {
    lastDirection = x > 0 ? "right" : "left";
  } else {
    lastDirection = y > 0 ? "up" : "down";
  }
}

function revealPrediction() {
  let number;

  if (lastDirection === "up") {
    number = 1;
  } else if (lastDirection === "right") {
    number = 2;
  } else if (lastDirection === "down") {
    number = 3;
  } else if (lastDirection === "left") {
    number = 4;
  } else {
    number = "?";
  }

  text.innerHTML = "My prediction is<br><br>" + number;
}

// Tap to begin
document.body.addEventListener("click", () => {
  if (!started) {
    requestMotionPermission();
  }
});
</script>

</body>
</html>
