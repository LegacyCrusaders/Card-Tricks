<script>
let armed = false;
let locked = false;
let faceDownConfirmed = false;

let lastTime = null;
let lastBeta = null;
let lastGamma = null;

const SPEED_THRESHOLD = 25;

document.body.addEventListener("click", async () => {
  if (armed) return;

  if (typeof DeviceMotionEvent !== "undefined" &&
      typeof DeviceMotionEvent.requestPermission === "function") {
    const permission = await DeviceMotionEvent.requestPermission();
    if (permission !== "granted") return;
  }

  armed = true;
  document.getElementById("message").innerText = "Set phone face down";
  window.addEventListener("deviceorientation", handleOrientation);
});

function handleOrientation(e) {
  if (!armed || locked) return;

  const beta = e.beta;   // front/back
  const gamma = e.gamma; // left/right
  const now = Date.now();

  // Phase 1: confirm face down
  if (!faceDownConfirmed) {
    if (Math.abs(beta) < 10 && Math.abs(gamma) < 10) {
      faceDownConfirmed = true;
      document.getElementById("message").innerText = "Lift the phone";
      lastTime = now;
      lastBeta = beta;
      lastGamma = gamma;
    }
    return;
  }

  // Phase 2: detect lift + speed
  if (lastTime !== null) {
    const dt = (now - lastTime) / 1000;
    const speed =
      Math.abs(beta - lastBeta) / dt +
      Math.abs(gamma - lastGamma) / dt;

    if (Math.abs(beta) > 45 || Math.abs(gamma) > 45) {
      locked = true;
      reveal(beta, gamma, speed);
    }
  }

  lastTime = now;
  lastBeta = beta;
  lastGamma = gamma;
}

function reveal(beta, gamma, speed) {
  const fast = speed > SPEED_THRESHOLD;
  let result = "";

  if (beta < -45) result = fast ? "2" : "1";      // top
  else if (gamma > 45) result = fast ? "4" : "3"; // right
  else if (beta > 45) result = fast ? "6" : "5";  // bottom
  else if (gamma < -45) result = fast ? "8" : "7";// left

  document.getElementById("message").innerText =
    "My prediction is:\n" + result;
}
</script>
