<script>
let armed = false;
let ready = false;
let lastTime = null;
let lastBeta = null;
let lastGamma = null;

const SPEED = 25;

document.body.onclick = async () => {
  if (armed) return;

  if (typeof DeviceMotionEvent !== "undefined" &&
      typeof DeviceMotionEvent.requestPermission === "function") {
    const p = await DeviceMotionEvent.requestPermission();
    if (p !== "granted") return;
  }

  armed = true;
  document.getElementById("msg").innerText = "Place phone face down";
  window.addEventListener("deviceorientation", handle);
};

function handle(e) {
  if (!armed) return;

  const beta = e.beta;
  const gamma = e.gamma;
  const now = Date.now();

  // FACE DOWN = screen clearly down
  const isFaceDown = Math.abs(beta) > 150;

  // If face down, arm the next reveal
  if (isFaceDown) {
    ready = true;
    lastTime = now;
    lastBeta = beta;
    lastGamma = gamma;
    document.getElementById("msg").innerText = "Lift the phone";
    return;
  }

  // Only reveal if we were face down first
  if (!ready || lastTime === null) return;

  const dt = (now - lastTime) / 1000;
  const speed =
    Math.abs(beta - lastBeta) / dt +
    Math.abs(gamma - lastGamma) / dt;

  // Clear directional tilt
  if (Math.abs(beta) > 45 || Math.abs(gamma) > 45) {
    ready = false; // require face-down again before next reveal
    reveal(beta, gamma, speed);
  }

  lastTime = now;
  lastBeta = beta;
  lastGamma = gamma;
}

function reveal(beta, gamma, speed) {
  const fast = speed > SPEED;
  let n = "?";

  if (beta < -45) n = fast ? 2 : 1;       // top
  else if (gamma > 45) n = fast ? 4 : 3;  // right
  else if (beta > 45) n = fast ? 6 : 5;   // bottom
  else if (gamma < -45) n = fast ? 8 : 7; // left

  document.getElementById("msg").innerText =
    "My prediction is:\n" + n;
}
</script>
