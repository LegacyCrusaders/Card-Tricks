<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Prediction</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<style>
  body {
    margin: 0;
    background: black;
    color: white;
    font-family: Arial, Helvetica, sans-serif;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100vh;
    text-align: center;
  }
  #text {
    font-size: 2.2em;
    padding: 20px;
  }
</style>
</head>
<body>

<div id="text">Tap to begin<br><br>Version 5</div>

<script>
let started = false;
let faceDown = false;
let revealed = false;
let lastDirection = null;

const text = document.getElementById("text");
const EARLY_Z_TRIGGER = -4;
let wakeLock = null;

// Hide URL bar
window.addEventListener("load", () => {
  setTimeout(() => {
    window.scrollTo(0,1);
  }, 100);
});

async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
      wakeLock.addEventListener('release', () => console.log('Wake lock released'));
    }
  } catch(e) {
    console.log('Wake lock unavailable:', e);
  }
}

function requestMotionPermission() {
  if (
    typeof DeviceMotionEvent !== "undefined" &&
    typeof DeviceMotionEvent.requestPermission === "function"
  ) {
    DeviceMotionEvent.requestPermission().then(response => {
      if (response === "granted") {
        startMotion();
        requestWakeLock();
      } else {
        text.innerHTML = "Motion permission denied";
      }
    });
  } else {
    startMotion();
    requestWakeLock();
  }
}

function startMotion() {
  started = true;
  text.innerHTML = "Version 5<br><br>Set phone down";
  window.addEventListener("devicemotion", handleMotion);
}

function handleMotion(event) {
  if (!event.accelerationIncludingGravity) return;

  const x = event.accelerationIncludingGravity.x;
  const y = event.accelerationIncludingGravity.y;
  const z = event.accelerationIncludingGravity.z;

  if (z < -7) {
    faceDown = true;
    revealed = false;
    text.innerHTML = "Version 5<br><br>(waiting)";
    return;
  }

  if (faceDown && !revealed && z > EARLY_Z_TRIGGER) {
    revealed = true;
    faceDown = false;
    revealPrediction();
  }

  if (Math.abs(x) > Math.abs(y)) {
    lastDirection = x > 0 ? "right" : "left";
  } else {
    lastDirection = y > 0 ? "up" : "down";
  }
}

function revealPrediction() {
  let number;
  if (lastDirection === "up") number = 1;
  else if (lastDirection === "right") number = 2;
  else if (lastDirection === "down") number = 3;
  else if (lastDirection === "left") number = 4;
  else number = "?";

  text.innerHTML = "My prediction is<br><br>" + number;
}

document.body.addEventListener("click", () => {
  if (!started) requestMotionPermission();
});
</script>

</body>
</html>
