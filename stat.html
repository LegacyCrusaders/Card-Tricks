<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Running Card Choice Statistics</title>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 460px;
  margin: 20px auto;
  padding: 20px;
  border: 2px solid #333;
  border-radius: 8px;
  background: #f9f9f9;
  user-select: none;
}
h1 { text-align:center; margin:0 0 8px; cursor:pointer; }
#description { text-align:center; font-size:14px; color:#555; margin-bottom:12px; font-style:italic; }
.input-area { display:flex; gap:16px; justify-content:space-between; align-items:center; }
.dropdowns { display:flex; flex-direction:column; gap:12px; }
.controls { display:flex; gap:8px; }
select { width:110px; padding:8px; font-size:16px; }
button { padding:8px 12px; font-size:14px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer; }
.card-display { font-size:80px; font-weight:bold; cursor:pointer; text-align:center; }
.card-display.red { color:red; }
.card-display.black { color:black; }
#result { margin-top:20px; font-size:20px; text-align:center; font-weight:bold; min-height:28px; }
#qrWrapper { display:flex; justify-content:center; margin-top:30px; }
#stackDisplay { display:none; font-family:monospace; font-size:14px; white-space:pre-wrap; margin-top:20px; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>

<h1 id="title">
  <span>Running Card</span>
  <span>Choice Statistics</span>
</h1>

<div id="description">
An ever updating data set on named card and number combinations.
</div>

<div class="input-area">
  <div class="dropdowns">
    <div class="controls">
      <select id="numberSelect"></select>
      <button id="randomNumberBtn">Randomize</button>
    </div>
    <div class="controls">
      <select id="cardSelect"></select>
      <button id="randomCardBtn">Randomize</button>
    </div>
  </div>
  <div id="cardDisplay" class="card-display black">A♠</div>
</div>

<button id="submitBtn">Submit</button>
<div id="result">Select a card and number.</div>

<div id="stackDisplay"></div>

<div id="qrWrapper">
  <div id="qrContainer"></div>
</div>

<script>
const SHEET_URL = 'https://script.google.com/macros/s/AKfycby3IIZk26_giu6v6EEO42QA2ogTFPE1S3oboRRhTDb2_ZjWDjL4UuhRGL20WtGgoNOukA/exec';

const mnemonicaStack = [
"4♣","2♦","7♦","3♣","9♠","Q♦","6♠","5♠","Q♣","2♠",
"J♦","8♣","3♠","7♣","5♥","10♠","K♦","2♣","3♥","8♠",
"6♦","5♣","K♠","9♥","A♣","4♠","J♥","10♦","10♣","K♥",
"3♦","8♥","6♣","10♥","9♣","4♥","Q♠","A♥","7♠","8♦",
"A♠","9♦","K♣","6♥","Q♥","2♥","7♥","5♦","4♦","A♦",
"J♣","J♠"
];

const sistebbinsOrder = [
'A♣','4♥','7♠','10♦','K♣','3♥','6♠','9♦','Q♣','2♥','5♠','8♦','J♣',
'A♥','4♠','7♦','10♣','K♥','3♠','6♦','9♣','Q♥','2♠','5♦','8♣','J♥',
'A♠','4♦','7♣','10♥','K♠','3♦','6♣','9♥','Q♠','2♦','5♣','8♥','J♠',
'A♦','4♣','7♥','10♠','K♦','3♣','6♥','9♠','Q♦','2♣','5♥','8♠','J♦'
];

const cardSelect = document.getElementById('cardSelect');
const numberSelect = document.getElementById('numberSelect');
const cardDisplay = document.getElementById('cardDisplay');
const resultDiv = document.getElementById('result');

let isFaceDown = false;
let pendingSpectatorData = null;
let lastDisplayedData = null;
let testMode = false;

function populate() {
  for (let i=1;i<=52;i++) numberSelect.add(new Option(i,i));
  const suits=['♣','♥','♠','♦'], vals=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
  suits.forEach(s=>vals.forEach(v=>{
    const o=new Option(v+s,v+s);
    if(s==='♥'||s==='♦') o.className='red';
    cardSelect.add(o);
  }));
}

function updateCardDisplay(card){
  cardDisplay.textContent = card;
  cardDisplay.className = 'card-display ' + ((card.includes('♥')||card.includes('♦'))?'red':'black');
}

function randomizeCard(){
  const c = mnemonicaStack[Math.floor(Math.random()*52)];
  cardSelect.value = c;
  updateCardDisplay(c);
}

function randomizeNumber(){
  numberSelect.value = Math.floor(Math.random()*52)+1;
}

document.getElementById('randomCardBtn').onclick = randomizeCard;
document.getElementById('randomNumberBtn').onclick = randomizeNumber;

cardSelect.onchange = () => updateCardDisplay(cardSelect.value);

function getPrevSS(card){
  const i = sistebbinsOrder.indexOf(card);
  return i<=0 ? sistebbinsOrder[51] : sistebbinsOrder[i-1];
}
function adjNum(n){ return n<=13 ? n+39 : n-13; }

async function checkSpectator(){
  const r = await fetch(SHEET_URL);
  const d = await r.json();
  if(!d.current) return;

  pendingSpectatorData = d.current;

  if(isFaceDown || testMode){
    const key = d.current.card+'-'+d.current.number;
    if(key!==lastDisplayedData){
      lastDisplayedData = key;
      const c = getPrevSS(d.current.card);
      const n = adjNum(d.current.number);
      cardSelect.value = c;
      numberSelect.value = n;
      updateCardDisplay(c);
      resultDiv.textContent = 'Chosen '+n;
    }
  }
}

setInterval(checkSpectator,2000);

window.addEventListener('deviceorientation',e=>{
  if(Math.abs(e.beta)>150) isFaceDown=true;
  if(Math.abs(e.beta)<30) isFaceDown=false;
});

populate();
randomizeCard();
randomizeNumber();

new QRCode(document.getElementById("qrContainer"), {
  text: "https://legacycrusaders.github.io/Card-Tricks/stat2.html",
  width: 180,
  height: 180
});
</script>

</body>
</html>
