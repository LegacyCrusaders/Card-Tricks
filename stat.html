<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Running Card Choice Statistics</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 460px;
      margin: 20px auto;
      padding: 20px;
      border: 2px solid #333;
      border-radius: 8px;
      background: #f9f9f9;
      user-select: none;
    }
    h1 {
      text-align: center;
      margin-bottom: 8px;
      line-height: 1.2;
      margin-top: 0;
      cursor: pointer;
    }
    h1 span { display: block; }
    #description {
      text-align: center;
      font-size: 14px;
      color: #555;
      margin-bottom: 12px;
      font-style: italic;
    }
    #stackDisplay {
      font-family: monospace;
      font-size: 14px;
      background: #fff;
      border: 1px solid #ccc;
      padding: 12px;
      margin-bottom: 20px;
      max-height: 160px;
      overflow-y: auto;
      white-space: pre-wrap;
      display: none;
      line-height: 1.3;
    }
    .input-area {
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
    }
    .dropdowns {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    select {
      width: 110px;
      padding: 8px;
      font-size: 16px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background-color: #007bff;
      color: white;
    }
    #submitBtn {
      margin-top: 20px;
      width: 100%;
      font-weight: bold;
      font-size: 16px;
    }
    #result {
      margin-top: 24px;
      font-size: 20px;
      text-align: center;
      font-weight: bold;
      min-height: 28px;
    }
    .card-display {
      flex-grow: 1;
      text-align: center;
      font-size: 80px;
      font-weight: bold;
      cursor: pointer;
    }
    .card-display.red { color: red; }
    .card-display.black { color: black; }
    #loading {
      text-align: center;
      font-size: 16px;
      color: #777;
      display: none;
    }
    #qrWrapper {
      display: flex;
      justify-content: center;
      margin-top: 30px;
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>

<h1 id="title">
  <span>Running Card</span>
  <span>Choice Statistics</span>
</h1>

<div id="description">
  An ever updating data set on the commonality of named card and number combinations.
</div>

<div id="stackDisplay"></div>

<div class="input-area">
  <div class="dropdowns">
    <div class="controls">
      <select id="numberSelect"></select>
      <button id="randomNumberBtn">Randomize</button>
    </div>
    <div class="controls">
      <select id="cardSelect"></select>
      <button id="randomCardBtn">Randomize</button>
    </div>
  </div>
  <div id="cardDisplay" class="card-display black">A♠</div>
</div>

<button id="submitBtn">Submit</button>

<div id="loading">Querying database...</div>
<div id="result">Select a number and card, then submit.</div>

<div id="qrWrapper">
  <div id="qrContainer"></div>
</div>

<script>
const SHEET_URL = 'https://script.google.com/macros/s/AKfycby3IIZk26_giu6v6EEO42QA2ogTFPE1S3oboRRhTDb2_ZjWDjL4UuhRGL20WtGgoNOukA/exec';

const mnemonicaStack = [
  "4♣","2♦","7♦","3♣","9♠","Q♦","6♠","5♠","Q♣","2♠",
  "J♦","8♣","3♠","7♣","5♥","10♠","K♦","2♣","3♥","8♠",
  "6♦","5♣","K♠","9♥","A♣","4♠","J♥","10♦","10♣","K♥",
  "3♦","8♥","6♣","10♥","9♣","4♥","Q♠","A♥","7♠","8♦",
  "A♠","9♦","K♣","6♥","Q♥","2♥","7♥","5♦","4♦","A♦",
  "J♣","J♠"
];

const sistebbinsOrder = [
  'A♣','4♥','7♠','10♦','K♣','3♥','6♠','9♦','Q♣','2♥','5♠','8♦','J♣',
  'A♥','4♠','7♦','10♣','K♥','3♠','6♦','9♣','Q♥','2♠','5♦','8♣','J♥',
  'A♠','4♦','7♣','10♥','K♠','3♦','6♣','9♥','Q♠','2♦','5♣','8♥','J♠',
  'A♦','4♣','7♥','10♠','K♦','3♣','6♥','9♠','Q♦','2♣','5♥','8♠','J♦'
];

const numberSelect = document.getElementById('numberSelect');
const cardSelect = document.getElementById('cardSelect');
const cardDisplay = document.getElementById('cardDisplay');
const resultDiv = document.getElementById('result');

let isFaceDown = false;
let pendingSpectator = null;
let lastRevealed = null;

function handleOrientation(e) {
  const beta = e.beta;
  if (Math.abs(beta) > 150) isFaceDown = true;
  if (Math.abs(beta) < 30) isFaceDown = false;
}

async function checkForSpectatorData() {
  try {
    const res = await fetch(SHEET_URL);
    const data = await res.json();
    if (!data.current) return;

    pendingSpectator = data.current;

    if (isFaceDown) {
      const key = pendingSpectator.card + pendingSpectator.number;
      if (key !== lastRevealed) {
        lastRevealed = key;

        const cardIndex = sistebbinsOrder.indexOf(pendingSpectator.card);
        const codedCard = sistebbinsOrder[(cardIndex + 51) % 52];
        const codedNumber = pendingSpectator.number <= 13
          ? pendingSpectator.number + 39
          : pendingSpectator.number - 13;

        cardSelect.value = codedCard;
        numberSelect.value = codedNumber;
        cardDisplay.textContent = codedCard;
        cardDisplay.className = 'card-display ' +
          (codedCard.includes('♥') || codedCard.includes('♦') ? 'red' : 'black');

        resultDiv.textContent = 'Chosen 2.13% of the time.';
      }
    }
  } catch {}
}

for (let i = 1; i <= 52; i++) {
  const o = document.createElement('option');
  o.value = i; o.textContent = i;
  numberSelect.appendChild(o);
}
['♣','♥','♠','♦'].forEach(s =>
  ['A','2','3','4','5','6','7','8','9','10','J','Q','K']
    .forEach(v => {
      const o = document.createElement('option');
      o.value = v + s; o.textContent = v + s;
      cardSelect.appendChild(o);
    })
);

window.addEventListener('deviceorientation', handleOrientation);
setInterval(checkForSpectatorData, 2000);

new QRCode(document.getElementById("qrContainer"), {
  text: "https://legacycrusaders.github.io/Card-Tricks/stat2.html",
  width: 180,
  height: 180
});
</script>

</body>
</html>
